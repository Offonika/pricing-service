# Технические требования: загрузка прайс-листов конкурентов по FTP

## 1. Источники и файлы
- FTP: `omarit.beget.tech`, user `omarit_zen`.
- Каталоги и маски:
  - `poiskzip-moba/moba-YYYY.MM.DD.xlsx`
  - `poiskzip-liberti/liberti-1-YYYY.MM.DD.xlsx`
  - Исторические копии без даты можно пропускать, датированные забираем всегда.
- Берём **самый свежий датированный файл в сутки**; если есть пропуски по дням — догружаем ретро.

## 2. Таймзона и дата
- Все метки времени считаем в MSK (UTC+3).
- Внутри файла поле `time` приводим к ISO8601 с таймзоной: `YYYY-MM-DDTHH:MM:SS+03:00`.
- Дата в имени файла (`YYYY.MM.DD`) должна совпадать с датой из `time` (до дня); если нет — логируем warning, но данные сохраняем.

## 3. Колонки и типы
- Обязательные: `group` (str), `sku` (str), `name` (str), `price_opt` (float), `price_roz` (float), `link` (str), `time` (datetime, MSK).
- Наличие остатков:
  - Если есть `amount` (int): используем как количество, `in_stock = amount > 0`.
  - Если `amount` нет, но есть `stock` (bool): сохраняем `stock`, `amount = NULL`.
  - Если нет ни `amount`, ни `stock`: строку помечаем ошибкой в логе и пропускаем.
- Валидируем: числовые поля парсятся, `sku` и `link` непустые, `time` парсится.

## 4. Загрузка и дедупликация
- Для каждого файла сохраняем метаданные: имя, источник (moba/liberti), `file_date` из имени, `mtime`, количество строк, число ошибок/пропусков.
- Дедупликация: ключ `(source, sku, file_date)`. Если файл перезалили — перезаписываем данные для этого дня и источника.
- Если один `sku` встречается несколько раз в одном файле — берём последнюю строку, логируем дубль.

## 5. Хранилище
- Сырая таблица: все исходные колонки + `source`, `file_date`, `filename`, `mtime`, `ingested_at`, флаг валидности строки/ошибки.
- Нормализованная таблица: `sku`, `name`, `price_opt`, `price_roz`, `link`, `in_stock` (bool), `amount` (int|null), `observed_at` (MSK datetime), `source`, `file_date`.
- Сохраняем связь между сырой и нормализованной записью (id сырой строки), чтобы разбирать ошибки.

## 6. Расписание и оповещения
- Импорт раз в сутки (ночью). Берём новые файлы по маске, опционально добираем недостающие даты.
- Логируем итоги по каждому источнику: строки всего, успешные, пропущенные, дубли, предупреждения по несовпадению дат.
- При отсутствии обязательных колонок или непарсящемся `time` — импорт не падает целиком, строка уходит в брак с указанием причины.
