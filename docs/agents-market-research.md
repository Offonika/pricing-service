<!-- File: docs/agents-market-research.md -->

# Агентный контур: рынок смартфонов и спрос на запчасти

Документ описывает, как агенты (ChatGPT/Codex) собирают данные о новых моделях смартфонов и спросе на запчасти через интеграцию с Яндекс.Директ. Дополняет `docs/PRD.md` (§4.4) и `docs/architecture.md` (разделы про агентный контур и внешние интеграции).

---

## 1. Роли и ответственность

### 1.1. Агент пресс-релизов и новостей
- **Цель:** находить новые модели смартфонов из официальных источников (сайты брендов, пресс-релизы, новости).
- **Поведение:** регулярно обходит конфигурируемый список URL по брендам; внутри агента лежит логика «что считать официальным анонсом».
- **Результат:** нормализованная запись с брендом/моделью/вариантом, датами анонса и старта продаж, опциональными параметрами экрана.
- **Интеграция:** вызывает backend-инструмент (абстрактно `POST /devices/models`) и пишет данные в таблицу наподобие `phone_models`; агент не хранит данные у себя.
- **Пример полезной структуры:**
```json
{
  "brand": "Samsung",
  "model": "Galaxy S26",
  "variant": "Ultra",
  "announce_date": "2026-02-10",
  "release_date": "2026-03-01",
  "screen": {
    "size_inch": 6.8,
    "technology": "AMOLED",
    "refresh_rate_hz": 120
  }
}
```

### 1.2. Генератор ключевых фраз под запчасти
- **Цель:** выпускать поисковые фразы под дисплеи/экраны/тач/стекло для новых моделей.
- **Поведение:** получает модель телефона (`phone_models`) и строит фразы по шаблонам (пример: `дисплей <brand> <model>`, `экран <brand> <model> купить`, `замена дисплея <brand> <model>`, `модуль экрана <brand> <model> оригинал`).
- **Интеграция:** реализуется как бэкенд-задача или агент; публикует результат в `keywords` через инструмент вроде `POST /keywords` или `POST /keywords/generate`.
- **Пример:**
```json
{
  "model_id": "uuid-or-internal-id",
  "brand": "Apple",
  "model": "iPhone 17",
  "phrases": [
    "дисплей iphone 17",
    "экран iphone 17 купить",
    "замена дисплея iphone 17",
    "модуль экрана iphone 17 оригинал"
  ]
}
```

### 1.3. Интеграция с Яндекс.Директ (спрос)
- **Цель:** получать статистику спроса по фразам из официального API Директа (не Wordstat-скрейпинг).
- **Поведение:** сервис `yandex_integration_service` хранит токен/креды, принимает список фраз и регион, вызывает API, возвращает прогноз показов/кликов и доступные метрики конкуренции/ставок.
- **Хранение:** результат сохраняется в `demand_stats` (или аналог) с привязкой к фразе, дате и региону.
- **Внешний интерфейс:** абстрактный метод `get_yandex_stats(phrases[], region) → [{phrase, impressions, clicks, date, ...}]`; агентов и ядро интересует только этот контракт.

---

## 2. Инструменты backend (tools), которые вызывают агенты
- `POST /devices/models` — принять нормализованную модель телефона и сохранить в `phone_models` (или аналог).
- `POST /keywords` / `POST /keywords/generate` — создать/сгенерировать набор фраз для модели, записать в `keywords`.
- `POST /demand/fetch` — инициировать запрос в Яндекс.Директ для пачки фраз и региона; внутри вызывает `get_yandex_stats`.

Конкретные URI финализируются в backend; агенты работают только через эти инструменты и не пишут напрямую в БД.

---

## 3. Запуски и триггеры
- Агент пресс-релизов — по расписанию (cron/планировщик); список источников и брендов задаётся в конфиге проекта.
- Генератор фраз — триггер на появление/обновление модели + периодический батч (например, раз в сутки) для повторной генерации при изменении шаблонов.
- Запросы к Яндекс.Директ — сразу после генерации фраз или по батчевому расписанию (день/неделя), с учётом лимитов API и региональных параметров.
- Повторные запросы — при смене региона, обновлении списка фраз или по расписанию для актуализации спроса.

---

## 4. Поток данных (текстовое описание)
1. Планировщик запускает агент пресс-релизов → агент читает источники → отправляет нормализованные модели в backend (`PhoneModel`).
2. Backend/агент формирует фразы по новым моделям → записывает в `Keyword`.
3. Сервис `yandex_integration_service` получает список фраз → обращается к API Директа → пишет агрегированную статистику в `DemandStat`.
4. pricing-engine использует `PhoneModel`, `Keyword`, `DemandStat` как признаки: ранний спрос на дисплеи/экраны, приоритет закупки, корректировки стратегий.

---

## 5. Использование в pricing-service
- Предсказуемая матрица закупок: новые модели и спрос по ним попадают в витрины раньше, чем появится статистика продаж.
- Приоритизация стратегий: новинки и высокоспросовые фразы могут получать отдельные правила/надбавки.
- Аналитика: витрины `phone_models` / `keywords` / `demand_stats` доступны для отчётов и BI, не требуя доступа к исходным пресс-релизам или Яндекс.Директ.

