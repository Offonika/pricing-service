<!-- File: docs/architecture.md -->

# Архитектура проекта «Умное ценообразование Master Mobile»

Документ описывает high-level архитектуру сервиса ценообразования, основные компоненты, потоки данных и схемы интеграций.

Исходные бизнес-требования и сценарии см. в `docs/PRD.md`.  
Общие правила разработки и работы Codex — в `docs/constitution.md`.  
План задач — в `docs/plan.md`.

---

## 1. Общий обзор

Сервис ценообразования — это отдельное приложение, которое:

1. **Импортирует данные**:
   - наши товары, закупочные цены, остатки из TopControl;
   - цены и наличие у конкурентов из парсера (ZennoPoster и др.).

2. **Хранит и обрабатывает данные** в БД (PostgreSQL):
   - товары (`Product`);
   - конкуренты (`Competitor`);
   - цены конкурентов (`CompetitorPrice`);
   - матчинги, стратегии и расчёты цен.

3. **Рассчитывает рекомендуемые цены** по стратегиям:
   - учитывая закупку, конкурентов, маржу, статусы товаров (ABC/XYZ и др.).

4. **Отдаёт результаты во внешние системы**:
   - выгрузка в 1С (файлы для документа «Установка цен номенклатуры»);
   - отчёты и списки проблемных позиций (через API и Telegram-бот).

---

## 2. Компоненты системы

### 2.1. Backend-сервис (FastAPI)

- Ядро системы.
- Отвечает за:
  - REST API для внутренних инструментов и Telegram-бота;
  - бизнес-логику импорта, матчинга, стратегий и расчётов;
  - подготовку данных для выгрузок в 1С.

Основные слои:

- `app/api/` — HTTP-эндпоинты (FastAPI routers).
- `app/schemas/` — Pydantic-схемы запросов/ответов.
- `app/services/` — бизнес-логика (импорт, матчинг, расчёт).
- `app/models/` — SQLAlchemy-модели БД.
- `app/core/` — конфиг, логирование, базовые утилиты.
- `app/workers/` — код фоновых задач (если используется Celery/RQ).

### 2.2. База данных (PostgreSQL)

Основные сущности (минимальный набор для MVP):

- `Product`
  - наши товары (SKU, название, бренд, категория, статусы, флаги ABC/XYZ и т.п.).
- `Competitor`
  - конкуренты (название, сайт, активность).
- `CompetitorPrice`
  - цены конкурентов по товарам (product_id, competitor_id, цена, наличие, дата сбора).
- `ProductMatch` (или аналог)
  - результаты матчинга наших товаров с карточками конкурентов.
- `PricingStrategy`
  - стратегии ценообразования (условия, параметры, приоритеты).
- `PriceRecommendation`
  - рассчитанные рекомендуемые цены, причины и технические метаданные (когда, по какой стратегии, какие входные данные использовались).

Схема и связи уточняются и поддерживаются через миграции Alembic.

### 2.3. Очередь фоновых задач (Celery или RQ + Redis)

Используется для:

- импорта больших файлов (TopControl, парсер конкурентов);
- пакетного пересчёта цен по многим товарам;
- формирования выгрузок для 1С по расписанию.

Типовые задачи:

- `import_topcontrol_dump(file_path)`
- `import_competitor_prices(file_path)`
- `recalculate_all_prices(strategy_set_id=...)`
- `generate_price_export_for_1c(date=...)`

Конкретный выбор (Celery vs RQ) будет зафиксирован отдельно; на уровне архитектуры допускаем оба варианта.

### 2.4. Внешние интеграции

#### TopControl

- Источник:
  - выгрузки DBF/CSV/Excel с номенклатурой, остатками, закупочными ценами.
- Способ интеграции:
  - вручную/по расписанию формируются файлы из TopControl;
  - файлы передаются сервису ценообразования (через папку/HTTP-API/интерфейс админки — определяется отдельной задачей);
  - модуль импорта читает файл, маппит данные в `Product` и связанные сущности.

#### Парсер конкурентов (ZennoPoster и др.)

- Источник:
  - CSV/Excel с ценами и наличием по конкурентам.
- Способ интеграции:
  - скрипт/бот парсинга складывает файлы в подготовленную директорию или отдаёт по API;
  - модуль импорта читает файл и заполняет `Competitor`, `CompetitorPrice`, обновляет `ProductMatch`.

#### 1С

- Назначение:
  - получение от сервиса ценообразования предложений по ценам для документа «Установка цен номенклатуры».
- Способ интеграции:
  - сервис формирует файл (CSV/Excel/другой согласованный формат);
  - 1С забирает файл из указанной директории или по HTTP-эндпоинту;
  - формат и правила считывания фиксируются в отдельной спецификации.

#### Telegram-бот

- Использует backend-API для:
  - получения агрегированных отчётов и списков товаров;
  - (опционально) подтверждения/отклонения цен.

---

## 3. Потоки данных (high-level)

1. **Импорт наших данных (TopControl)**
   - TopControl формирует выгрузку (DBF/CSV/Excel).
   - Файл поступает в сервис ценообразования.
   - Фоновая задача `import_topcontrol_dump`:
     - разбирает файл;
     - обновляет таблицы `Product` (и, при необходимости, таблицы остатков/закупок);
     - логирует количество обработанных/пропущенных записей.

2. **Импорт цен конкурентов**
   - Парсер конкурентов выдаёт CSV/Excel с ценами и наличием.
   - Фоновая задача `import_competitor_prices`:
     - обновляет `Competitor` и `CompetitorPrice`;
     - при необходимости обновляет/создаёт связи в `ProductMatch`.

3. **Матчинг товаров и карточек конкурентов**
   - Запускается по расписанию или после импорта.
   - Использует правила (по SKU, названию, бренду и т.д.).
   - Результат сохраняется в `ProductMatch` с флагами надёжности матча.

4. **Расчёт рекомендованных цен**
   - Фоновая задача `recalculate_all_prices`:
     - выбирает активные товары и связанные данные;
     - применяет стратегии (`PricingStrategy` и бизнес-правила из PRD);
     - сохраняет результат в `PriceRecommendation` с объяснением (поля «почему так»).
   - Возможен выбор стратегий по группам товаров, брендам, статусам и т.д.

5. **Выгрузка и отчёты**
   - Фоновые/ручные задачи для формирования:
     - файлов для 1С (по рекомендуемым ценам);
     - отчётов для коммерческого директора (API/витрины).
   - Telegram-бот или веб-интерфейс показывает:
     - агрегированные показатели;
     - проблемные позиции (сомнительный матч, маржа ниже порога, эксклюзивы и т.п.).

---

## 4. Структура каталогов (поддерживается Codex)

Минимальная целевая структура репозитория:

- `app/`
  - `api/` — роуты FastAPI
  - `core/` — конфиги, логирование, общие утилиты
  - `models/` — SQLAlchemy-модели
  - `schemas/` — Pydantic-схемы
  - `services/`
    - `importers/` — импорт TopControl, парсер конкурентов
    - `pricing_strategies/` — логика стратегий
    - другие сервисы
  - `workers/` — фоновые задачи (Celery/RQ)
- `tests/` — unit и интеграционные тесты
- `infra/`
  - `docker-compose.yml`
  - при необходимости `k8s/`
- `docs/`
  - `PRD.md`
  - `constitution.md`
  - `architecture.md`
  - `plan.md`
  - `price-strategies.md`
  - `agents.md`
- `tasks/` — детальные ТЗ по задачам из `plan.md`
- `scripts/` — вспомогательные скрипты (миграции, импорты, dev-utils)

---

## 5. Нефункциональные требования (архитектурный уровень)

- Обработка целевого объёма данных (≈ 1000+ товаров, 4–5 конкурентов) в пределах минут при пересчёте.
- Возможность масштабировать:
  - по количеству товаров и конкурентов;
  - по частоте пересчёта.
- Детальное логирование:
  - импорта,
  - матчинга,
  - расчёта цен,
  - выгрузок.
- Объяснимость:
  - для каждой рекомендованной цены хранить входные параметры и причины.

---

## 6. Открытые вопросы

Эти пункты требуют отдельного уточнения и могут повлиять на архитектуру:

1. Конкретный формат файлов для обмена с 1С (CSV, Excel, DBF, XML).
2. Финальный выбор очереди задач: Celery или RQ (и связанный стек мониторинга).
3. Стратегия хранения истории:
   - глубина хранения старых расчётов цен;
   - объём логов и политика архивирования.
4. Наличие/отсутствие отдельной админ-панели (веб-интерфейса) для управления стратегиями и выгрузками
   (на первых этапах может отсутствовать, управление через файлы/конфиги).

Все решения по этим пунктам должны быть зафиксированы в отдельные задачи в `docs/plan.md` и реализовываться по мере развития проекта.
