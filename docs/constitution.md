<!-- constitution.md -->

# 1. Проект

Название: «Умное ценообразование Master Mobile на базе TopControl и мониторинга конкурентов».

Цель: построить сервис, который:
- автоматически собирает данные по конкурентам и нашим остаткам/закупкам;
- по прозрачным правилам рассчитывает рекомендуемые цены на каждую позицию;
- формирует списки, где нужны ручные решения (дорогие, новые, эксклюзивные позиции);
- работает в одной логике с TopControl (ABC/XYZ, статусы запасов и товаров) и 1С.

MVP: пилот на ограниченном пуле номенклатуры (≈ 1000 позиций, 4–5 конкурентов) с ежедневным пересчётом цен и выгрузкой предложений в 1С.

---

# 2. Документы-источники правды

Основные артефакты проекта:

- **PRD**: `docs/PRD.md`  
  - Описывает бизнес-цели, роли, сценарии, требования к данным и стратегиями цен.
  - Любые изменения бизнес-логики сначала вносятся в PRD, затем отражаются в коде и других документах.
- **Конституция проекта**: `docs/constitution.md` (этот файл)  
  - Фиксирует договорённости по стеку, структуре, правилам работы Codex и DoD.
- **План работ**: `docs/plan.md`  
  - Список задач с чекбоксами по спринтам/этапам (S1, S2, S3…).
- **Стратегии и формулы**: `docs/price-strategies.md`  
  - Детализированные формулы и примеры расчёта цен.
- **Архитектура**: `docs/architecture.md`  
  - Схемы модулей, БД, интеграций (TopControl, ZennoPoster, 1С, Telegram-бот).
- **Роли агентов**: `docs/agents.md`  
  - Описывает Codex-агентов, их зоны ответственности и файлы контекста.

PRD и эта конституция — главные источники правды. Если код противоречит PRD, приоритет у PRD.

---

# 3. Технологический стек

Backend:
- Python 3.12+
- FastAPI (REST API)
- SQLAlchemy + Alembic (ORM и миграции)
- Очередь фоновых задач: Celery или RQ (будет уточнено в `docs/architecture.md`)
- Redis как брокер/кэш

Хранилище данных:
- PostgreSQL (основные сущности: товары, конкуренты, матчинги, стратегии, расчёты цен).

Интеграции:
- **TopControl** — чтение выгрузок (DBF/CSV/Excel) с номенклатурой, остатками, закупочными ценами.
- **Парсер конкурентов** (ZennoPoster и др.) — чтение CSV/Excel с ценами и наличием конкурентов.
- **1С** — выгрузка предложений по ценам в формате, удобном для документа «Установка цен номенклатуры».
- **Telegram-бот** — отображение отчётов, задач для ручного пересмотра цен и подтверждений.

Инфраструктура:
- Docker / docker-compose для локального и dev-окружения.
- CI/CD (GitHub Actions или аналог) — линтеры, тесты, деплой на staging.

---

# 4. Структура репозитория

Предполагаемая структура:

- `app/`
  - `api/` — FastAPI роуты (HTTP API)
  - `core/` — общие компоненты (конфиг, логирование, ошибки)
  - `models/` — SQLAlchemy-модели
  - `schemas/` — Pydantic-схемы
  - `services/` — бизнес-логика (матчинг, стратегии, расчёт)
  - `workers/` — фоновые задачи (импорты, пересчёты)
- `tests/` — автотесты (unit + интеграционные)
- `infra/`
  - `docker-compose.yml`
  - `k8s/` (при появлении Kubernetes)
- `docs/`
  - `PRD.md`
  - `constitution.md`
  - `plan.md`
  - `architecture.md`
  - `price-strategies.md`
  - `agents.md`
- `tasks/` — подробные ТЗ на задачи (`S1.2-*.md`, `S2.3-*.md` и т.д.)
- `scripts/` — утилитарные скрипты (миграции, импорты, dev-tools)

Codex обязан соблюдать эту структуру и не создавать хаотичных файлов вне договорённой схемы.

---

# 5. Домены системы

Главные логические блоки:

1. **Импорт данных**
   - Товары, закупки, остатки из TopControl.
   - Цены и наличие у конкурентов из парсера.
   - Нормализация и хранение сырых данных + витрин для расчёта.

2. **Ядро ценообразования**
   - Матчинг наших товаров с карточками конкурентов.
   - Применение стратегий (правила, приоритеты, ограничения по марже и т.п.).
   - Расчёт рекомендуемых цен с обоснованием (почему именно такая цена).

3. **Выгрузка и витрины**
   - Формирование выгрузок/реестров для 1С.
   - Отчёты для коммерческого директора и закупщиков (веб/Telegram).
   - Списки товаров, где нужно ручное решение.

4. **Управление стратегиями**
   - CRUD по стратегиям в терминах бизнеса (группы товаров, бренды, категории, статусы).
   - Возможность настраивать правила без изменения кода.

---

# 6. Работа с планом (`plan.md`) и задачами (`tasks/*.md`)

## 6.1. Формат `plan.md`

В файле `docs/plan.md` хранятся все задачи проекта с чекбоксами:

- Невыполненные задачи: строки формата  
  `- [ ] S1.2 — Добавить модели БД: Товар, Конкурент, ЦенаКонкурента`
- Выполненные задачи: строки формата  
  `- [x] S1.2 — Добавить модели БД: Товар, Конкурент, ЦенаКонкурента`

Задачи группируются по этапам:
- `S1` — базовая инфраструктура и модели данных,
- `S2` — стратегии и расчёты,
- `S3` — витрины, отчёты, Telegram-бот,
- и т.д.

## 6.2. Детализация задач в `tasks/*.md`

Для крупных задач создаются файлы:

- `tasks/S1.2-db-models.md`
- `tasks/S2.1-strategies-core.md`
- …

В каждом файле:
- цель задачи;
- требования к реализации;
- файлы, в которые вносятся изменения;
- Definition of Done для конкретной задачи (что должно быть сделано, чтобы пометить её как выполненную).

## 6.3. Поведение Codex с планом

Когда Codex получает команду вида  
«Сделай следующую невыполненную задачу из плана»:

1. Открыть `docs/plan.md`.
2. Найти **первую сверху** строку формата `- [ ] S*.? — …` в рамках указанного этапа (если он указан).
3. Запомнить `TASK_ID` (например, `S1.2`).
4. Попробовать открыть соответствующий файл в `tasks/`:
   - `tasks/TASK_ID-*.md` (если есть) и следовать его требованиям.
5. Выполнить задачу:
   - внести изменения в код, тесты, документацию;
   - убедиться, что тесты проходят.
6. После завершения:
   - обновить строку в `docs/plan.md`, заменив `- [ ]` на `- [x]` для соответствующей задачи;
   - при необходимости кратко обновить `docs/architecture.md` или другие профильные документы.
7. За один запуск Codex выполняет **ровно одну задачу** из `plan.md`.

Если в `plan.md` нет строк `- [ ]`, Codex обязан сообщить, что план выполнен и новые задачи не найдены.

---

# 7. Правила для Codex и агентов

## 7.1. Общие принципы

- Всегда сверяться с `docs/PRD.md` и `docs/constitution.md` перед изменением архитектурно значимых частей.
- Не ломать существующий API без обновления документации и миграционных шагов.
- Поддерживать читаемость и простоту архитектуры (модули с чёткой ответственностью).

## 7.2. Ограничения и безопасность

- Codex работает только в рамках текущего репозитория.
- Доступы к продакшн-среде, секреты и реальные ключи не хардкодятся в репозитории.
- Любые настройки окружения — через `.env` и переменные окружения, либо через секреты CI/CD.
- Никаких destructive-операций с боевыми БД и серверами (truncate/drop в продакшене запрещены).

## 7.3. Стиль кода и тесты

- Python-код с типизацией (type hints).
- Линтеры: `ruff`/`flake8` + `black` (или аналогичный форматтер).
- Тесты: `pytest`.
- Для каждого нового модуля/функции бизнес-логики должны быть unit-тесты, минимум happy-path и базовые edge-cases.
- Изменения в схеме БД всегда сопровождаются миграцией Alembic.

---

# 8. Definition of Done (общий)

Любая задача считается выполненной, только если:

1. Реализован код и при необходимости миграции;
2. Добавлены/обновлены тесты, все тесты проходят локально и в CI;
3. Обновлена документация:
   - при изменении API — обновлён Swagger/описание эндпоинтов;
   - при изменении архитектуры — обновлён `docs/architecture.md`;
   - при изменении бизнес-логики расчётов — обновлён `docs/price-strategies.md`.
4. Задача в `docs/plan.md` переведена из `- [ ]` в `- [x]`.

---

# 9. Логирование и наблюдаемость

- Все фоновые процессы (импорт, матчинг, расчёт, выгрузка) должны логировать шаги и ключевые метрики (количество обработанных товаров, количество ошибок).
- Ошибки и исключения логируются с контекстом (идентификаторы задач, файлов, товаров).
- В дальнейшем планируется подключение Prometheus/Grafana для метрик — детали будут описаны в `docs/architecture.md`.

---

# 10. Открытые вопросы (подлежат уточнению)

- Точный формат обмена с 1С (CSV/Excel/DBF, структура файлов).
- Финальный выбор очереди задач (Celery vs RQ) и стратегия ретраев.
- Детали интерфейса для управления стратегиями (веб-интерфейс, только API, Telegram-бот).

До уточнения этих пунктов Codex не должен принимать окончательные архитектурные решения по этим вопросам без явного указания в PRD или дополнительных документах.
