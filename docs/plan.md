<!-- File: docs/plan.md -->

# План проекта «Умное ценообразование Master Mobile»

Этот файл — **todo-лист проекта**.  
Codex и разработчики берут задачи отсюда, выполняют их и отмечают как выполненные, меняя `- [ ]` на `- [x]`.

- Невыполненная задача: `- [ ] S1.2 — ...`
- Выполненная задача: `- [x] S1.2 — ...`

Для крупных задач создаются подробные ТЗ в `tasks/S*.?-*.md`  
(например, `tasks/S1.2-db-models.md`), в которых можно указать:

```text
Recommended Agent: pricing-backend
```

---

## S0. Подготовка и базовая инфраструктура

- [x] S0.1 — Инициализировать репозиторий проекта  
  Git-репозиторий, `.gitignore`, минимальный `README.md`.
- [x] S0.2 — Настроить базовое окружение разработки  
  Зависимости (FastAPI, Uvicorn, SQLAlchemy, Alembic, Pydantic, pytest), линтер/форматтер.
- [x] S0.3 — Настроить Docker для dev-среды  
  `infra/docker-compose.yml`, `Dockerfile`, `.env.example`.
- [x] S0.4 — Настроить минимальный CI  
  Workflow с установкой зависимостей, линтером и тестами.

## S1. Базовая архитектура сервиса и модели данных
Фокус: каркас FastAPI-сервиса, схема БД, базовый healthcheck.

- [x] S1.1 — Создать каркас приложения FastAPI  
  Структура каталогов, точка входа, эндпоинт `/health`, Pydantic Settings.
- [x] S1.2 — Определить базовые модели БД  
  Product, Competitor, CompetitorPrice, связи relationship.
- [ ] S1.3 — Настроить Alembic и первую миграцию  
  Инициализация Alembic, миграция для базовых таблиц.
- [ ] S1.4 — Добавить базовый модуль логирования  
  Единый логгер, middleware для запросов/ошибок.
- [ ] S1.5 — Описать архитектуру на уровне high-level  
  Актуализация `docs/architecture.md`, потоки данных, очередь задач.
- [ ] S1.6 — Добавить первые интеграционные тесты  
  Тесты для `/health` и подключения к БД.

## S2. Импорт данных и ядро ценообразования
Фокус: импорт TopControl и конкурентов, матчинги, базовые стратегии.

- [ ] S2.1 — Импорт товаров и остатков из TopControl  
  Чтение DBF/CSV/Excel, маппинг в Product и связанные таблицы.
- [ ] S2.2 — Импорт цен конкурентов  
  Чтение CSV/Excel из парсера, Competitor/CompetitorPrice, логирование.
- [ ] S2.3 — Реализовать базовый модуль матчинга товаров и карточек конкурентов  
  Алгоритм по SKU/названию, хранение ProductMatch, флаги сомнительных матчей.
- [ ] S2.4 — Реализовать базовое ядро стратегий ценообразования  
  Модуль `app/services/pricing_strategies/`, базовая стратегия «не ниже закупки + минимальная маржа».
- [ ] S2.5 — Реализовать сервис расчёта рекомендованной цены  
  Возврат рекомендованной цены и причин, unit-тесты.
- [ ] S2.6 — Реализовать фоновые задачи на пересчёт цен  
  Очередь задач (Celery или RQ), задача массового пересчёта, логирование.
- [ ] S2.7 — Добавить API-эндпоинты для чтения расчётов  
  Список товаров с ценами и детализация по позиции, Pydantic-схемы, интеграционные тесты.

## S3. Выгрузка в 1С, отчёты и Telegram-бот
Фокус: витрины для бизнес-пользователей, экспорт цен, ручные решения.

- [ ] S3.1 — Реализовать выгрузку предложений по ценам для 1С  
  Определить формат файла, генерация, логирование и тесты.
- [ ] S3.2 — Реализовать отчёты для коммерческого директора  
  Товары с изменениями, позиции для ручного решения, агрегаты.
- [ ] S3.3 — Реализовать Telegram-бот (MVP)  
  Команды `/today`, `/alerts`, только чтение из backend.
- [ ] S3.4 — Поддержать сценарий ручного подтверждения цен через Telegram  
  UX «Принять/Отклонить», backend API, логирование действий.
- [ ] S3.5 — Финальный проход по документации и DoD  
  Сверка с `docs/PRD.md`, `docs/constitution.md`, `docs/architecture.md`, `docs/price-strategies.md`, `docs/RELEASE_NOTES.md` для MVP.

## S4. Опциональные улучшения (после MVP)
Эти задачи не обязательны для MVP, но полезны для развития.

- [ ] S4.1 — Добавить продвинутую аналитику по оборачиваемости и ABC/XYZ
- [ ] S4.2 — Добавить историю изменений стратегий и цен
- [ ] S4.3 — Интеграция с BI (Power BI / Metabase / др.)
- [ ] S4.4 — Расширенный Telegram-интерфейс (фильтры, поиск, уведомления)

---

### Правила работы Codex с этим планом
Если команда звучит как «Сделай следующую невыполненную задачу из плана (в S1 / S2 / S3)», агент:

1. Открывает `docs/plan.md`.
2. Находит первую сверху строку `- [ ]` в указанном блоке.
3. Ищет `tasks/TASK_ID-*.md` (если есть) и выполняет задачу по нему.
4. По завершении меняет `- [ ]` на `- [x]` для этой строки.
5. При необходимости обновляет документацию/тесты/миграции.

За один запуск выполняется ровно одна задача. Если нет ни одной строки `- [ ]`, агент сообщает, что план выполнен и новых задач нет.
