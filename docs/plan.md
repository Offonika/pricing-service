<!-- File: docs/plan.md -->

# План проекта «Умное ценообразование Master Mobile»

Этот файл — **todo-лист проекта**.  
Codex и разработчики берут задачи отсюда, выполняют их и отмечают как выполненные, меняя `- [ ]` на `- [x]`.

- Невыполненная задача: `- [ ] S1.2 — ...`
- Выполненная задача: `- [x] S1.2 — ...`

Для крупных задач создаются подробные ТЗ в `tasks/S*.?-*.md`  
(например, `tasks/S1.2-db-models.md`), в которых можно указать:

```text
Recommended Agent: pricing-backend
```

---

## S0. Подготовка и базовая инфраструктура

- [x] S0.1 — Инициализировать репозиторий проекта  
  Git-репозиторий, `.gitignore`, минимальный `README.md`.
- [x] S0.2 — Настроить базовое окружение разработки  
  Зависимости (FastAPI, Uvicorn, SQLAlchemy, Alembic, Pydantic, pytest), линтер/форматтер.
- [x] S0.3 — Настроить Docker для dev-среды  
  `infra/docker-compose.yml`, `Dockerfile`, `.env.example`.
- [x] S0.4 — Настроить минимальный CI  
  Workflow с установкой зависимостей, линтером и тестами.

## S1. Базовая архитектура сервиса и модели данных
Фокус: каркас FastAPI-сервиса, схема БД, базовый healthcheck.

- [x] S1.1 — Создать каркас приложения FastAPI  
  Структура каталогов, точка входа, эндпоинт `/health`, Pydantic Settings.
- [x] S1.2 — Определить базовые модели БД  
  Product, Competitor, CompetitorPrice, связи relationship.
- [x] S1.3 — Настроить Alembic и первую миграцию  
  Инициализация Alembic, миграция для базовых таблиц.
- [x] S1.4 — Добавить базовый модуль логирования  
  Единый логгер, middleware для запросов/ошибок.
- [x] S1.5 — Описать архитектуру на уровне high-level  
  Актуализация `docs/architecture.md`, потоки данных, очередь задач.
- [x] S1.6 — Добавить первые интеграционные тесты  
  Тесты для `/health` и подключения к БД.

## S2. Импорт данных и ядро ценообразования
Фокус: импорт TopControl и конкурентов, матчинги, базовые стратегии.

- [x] S2.1 — Импорт товаров и остатков из TopControl  
  Чтение DBF/CSV/Excel, маппинг в Product и связанные таблицы.
- [x] S2.2 — Импорт цен конкурентов  
  Чтение CSV/Excel из парсера, Competitor/CompetitorPrice, логирование.
- [x] S2.3 — Реализовать базовый модуль матчинга товаров и карточек конкурентов  
  Алгоритм по SKU/названию, хранение ProductMatch, флаги сомнительных матчей.
- [x] S2.4 — Реализовать базовое ядро стратегий ценообразования  
  Модуль `app/services/pricing_strategies/`, базовая стратегия «не ниже закупки + минимальная маржа».
- [x] S2.5 — Реализовать сервис расчёта рекомендованной цены  
  Возврат рекомендованной цены и причин, unit-тесты.
- [x] S2.6 — Реализовать фоновые задачи на пересчёт цен  
  Очередь задач (Celery или RQ), задача массового пересчёта, логирование.
- [x] S2.7 — Добавить API-эндпоинты для чтения расчётов  
  Список товаров с ценами и детализация по позиции, Pydantic-схемы, интеграционные тесты.

## S3. Выгрузка в 1С, отчёты и Telegram-бот
Фокус: витрины для бизнес-пользователей, экспорт цен, ручные решения.

- [x] S3.1 — Реализовать выгрузку предложений по ценам для 1С  
  Определить формат файла, генерация, логирование и тесты.
- [x] S3.2 — Реализовать отчёты для коммерческого директора  
  Товары с изменениями, позиции для ручного решения, агрегаты.
- [x] S3.3 — Реализовать Telegram-бот (MVP)  
  Команды `/today`, `/alerts`, только чтение из backend.
- [x] S3.4 — Поддержать сценарий ручного подтверждения цен через Telegram  
  UX «Принять/Отклонить», backend API, логирование действий.
- [x] S3.5 — Финальный проход по документации и DoD  
  Сверка с `docs/PRD.md`, `docs/constitution.md`, `docs/architecture.md`, `docs/price-strategies.md`, `docs/RELEASE_NOTES.md` для MVP.

## S4. Опциональные улучшения (после MVP)
Эти задачи не обязательны для MVP, но полезны для развития.

- [ ] S4.1 — (отложено, считаем в TopControl) Добавить продвинутую аналитику по оборачиваемости и ABC/XYZ
- [x] S4.2 — Добавить историю изменений стратегий и цен
- [x] S4.3 — Интеграция с BI (Power BI / Metabase / др.)
- [x] S4.4 — Расширенный Telegram-интерфейс (фильтры, поиск, уведомления)
- [x] S4.5 — Конфиг переключения источника конкурентов и Proxy API  
  COMPETITOR_SOURCE_MODE (zenno/internal), COMPETITOR_PARSE_LIMIT, PROXY_API_URL/TOKEN в конфиге и документации.
- [x] S4.6 — HTTP-клиент через Proxy API и ограничения RPS/таймаутов  
  Обёртка для запросов к конкурентам, ретраи, базовое логирование/алерты при недоступности прокси.
- [x] S4.7 — Встроенные парсеры конкурентов (moba, green-spark, ultra-details, memstech)  
  Разбор HTML/JSON в единый формат, ограничение выборки первыми N позициями для отладки.
- [x] S4.8 — Таска/планировщик парсинга с записью в БД  
  Запуск по списку конкурентов, применение лимита COMPETITOR_PARSE_LIMIT, запись в Competitor/CompetitorPrice (+опционально raw-лог).
- [x] S4.9 — Тесты и наблюдаемость для парсинга  
  Юнит-тесты парсеров на фикстурах, интеграционный тест с мок-прокси, метрики/логи успешных/ошибочных запросов.
- [x] S4.10 — Техтребования для FTP-импорта прайсов конкурентов (poiskzip-moba, poiskzip-liberti)  
  Формат датированных файлов, таймзона MSK, обязательные колонки, правила дедупликации/логирования.
- [x] S4.11 — Реализовать ежедневный FTP-импорт датированных прайсов конкурентов  
  Загрузка файлов по маске, парсинг в сырое/нормализованное хранилище, дедуп по (source, sku, file_date), логирование ошибок/пропусков.
- [x] S4.12 — Техдизайн матчинга конкурентов с номенклатурой  
  Документ с полями TopControl (tovar/ostatki), правилами нормализации SKU/код инфсистемы, ручными оверрайдами, целевой записью в competitor_price.
- [x] S4.13 — Реализовать матчинг FTP-цен конкурентов к товарам TopControl  
  Правила по артикулам/альткодам, оверрайды, лог unmatched/ambiguous, запись в competitor_price, CLI/таска для прогона по новым файлам.

## S5. Агентный контур рынка смартфонов и спроса (DeviceModel → Keywords → Яндекс.Директ)
Фокус: полный цикл новых моделей телефонов, ключей под запчасти и метрик спроса.

- [x] S5.1 — Миграции для PhoneModel/Keyword/KeywordDemand  
  Alembic-модели и таблицы под новые сущности, уникальные индексы, служебные поля.
- [x] S5.2 — Репозитории и базовые сервисы  
  CRUD/поиск по бренду+модели, генерация ключей по шаблонам, выбор моделей без ключей.
- [x] S5.3 — Интеграция Яндекс.Директ: клиент и DemandService  
  Клиент с токеном/базовым URL из конфига, батч-запросы, сохранение KeywordDemand.
- [x] S5.4 — API для агентов (/api/agents/*)  
  Приём моделей и ключей, схема запросов/ответов, базовые лимиты/валидация.
- [x] S5.5 — Интеграция в pricing-engine (доступ к спросу)  
  Поставщик метрик спроса для стратегий, фича-флаг для включения использования.
- [x] S5.6 — Фоновое обновление спроса  
  Планировщик/таска для регулярного вызова Яндекс.Директ, логирование и лимиты.
- [x] S5.7 — Наблюдаемость и фича-флаги  
  FEATURE_YANDEX_DEMAND_ENABLED, логирование ошибок/успехов, метрики по обновлениям.
- [x] S5.8 — Матчинг Product ↔ PhoneModel для использования спроса в pricing  
  Правила сопоставления бренда/модели из TopControl с PhoneModel, ручные правки/логирование нестыковок.
- [x] S5.9 — Критерии «официального анонса» и список источников для агента  
  Конфиг списка брендов/URL, правила валидации новостей/пресс-релизов, алерты при неуспехе обхода.
- [x] S5.10 — Лимиты и тесты для Яндекс.Директ  
  Батчинг, RPS/timeout в клиенте, фиксация метрик (показы/клики/ctr/bids) и мок-интеграционный тест.
- [x] S5.11 — Уточнение использования спроса в стратегиях  
  Фича-флаг, API провайдера спроса, точки подключения в стратегиях/витринах, поведение при отсутствии данных.
- [x] S5.12 — Свежесть данных и лимиты фоновых задач  
  Критерии выбора ключей без свежих данных (например, >7 дней), лимит ключей за прогон, обработка ошибок.
- [ ] S5.13 — OpenAI/LLM-агент для поиска новинок смартфонов  
  - Конфиг источников (бренд → список URL, правила «официального анонса»).  
  - Агент-скрипт: обход URL, извлечение brand/model/variant/даты/экран через LLM-промпт или парсинг.  
  - Отправка в backend: `POST /api/agents/devices/models` (и опционально `/keywords/bulk`).  
  - Планировщик (cron/systemd) и базовое логирование/ретраи.
- [x] S5.14 — Модуль мониторинга новинок смартфонов (News API + LLM)  
  Таблица `smartphone_releases`, коннектор к новостному API, LLM-нормализация, dedup/upsert, job `python -m tasks.update_smartphone_releases`, документация в PRD/архитектуре.

---

### Правила работы Codex с этим планом
Если команда звучит как «Сделай следующую невыполненную задачу из плана (в S1 / S2 / S3)», агент:

1. Открывает `docs/plan.md`.
2. Находит первую сверху строку `- [ ]` в указанном блоке.
3. Ищет `tasks/TASK_ID-*.md` (если есть) и выполняет задачу по нему.
4. По завершении меняет `- [ ]` на `- [x]` для этой строки.
5. При необходимости обновляет документацию/тесты/миграции.

За один запуск выполняется ровно одна задача. Если нет ни одной строки `- [ ]`, агент сообщает, что план выполнен и новых задач нет.
