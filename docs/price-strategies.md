<!-- File: docs/price-strategies.md -->

# Стратегии ценообразования (MVP)

Документ конкретизирует правила расчёта цен для пилота (≈1000 позиций, 4–5 конкурентов) и опирается на `docs/PRD.md` и `docs/architecture.md`.  
Цель: зафиксировать набор стратегий, входные данные и формулы по умолчанию, чтобы бизнес-логика была прозрачной и воспроизводимой.

## 1. Входные данные и допущения

- **Закупочная цена**: берём из опорного типа цены TopControl/1С (уточняется в S3.1).
- **Цены конкурентов**: история CSV/Excel от парсера (минимум `name`, `price`, `availability`, `url`, `date`).
- **Статусы из TopControl**: Новинка, Нет продаж, Сверхнорматив/Супернеликвид, ABC/XYZ, дефицит.
- **Признаки сервиса**: эксклюзив (есть у нас, нет у конкурентов), дорогая позиция (порог TBD), сомнительный матч.
- **Курс валют**: источник и порог изменения уточняются (см. PRD §5.4).
- Все расчёты сохраняют объяснение (какая стратегия, какие ограничения сработали).

Открытые вопросы (нужно закрыть в соответствующих задачах плана):
- Порог «дорогого» товара и дефицита/сверхнорматива.
- Минимальная маржа по умолчанию и на группы.
- Формат файла для 1С и тип опорной цены (закупочная/розничная).

## 2. Каталог стратегий (первый набор)

### 2.1. Базовая маржа и нижняя граница
- Применяется ко всем товарам, если не сработала более специфичная стратегия.
- Формула:  
  `floor = purchase_price * (1 + min_margin)`  
  `reference = min_competitor_price` (по активным конкурентам из списка)  
  `recommended = max(floor, reference)`  
- Если нет цен конкурентов → `recommended = floor` и флаг `no_competitor_data`.
- Если floor > reference, сохраняем причину `floor_above_market`.

### 2.2. Ориентир на конкретного конкурента/среднюю цену
- Используется для групп, где выбран эталонный конкурент или нужен «средний рынок».
- Варианты reference: `min`, `avg`, или цена конкретного конкурента из whitelist.
- Whitelist по умолчанию для пилота: moba.ru, green-spark.ru, ultra-details.ru, memstech.ru (может расширяться под новые рынки).
- Формула: `recommended = max(floor, reference * (1 + uplift_pct))`, uplift может быть отрицательным.

### 2.3. Эксклюзивы
- Если товар есть только у нас → надбавка к floor.
- Формула: `recommended = floor * (1 + exclusive_markup)`; минимум `exclusive_markup` > 0.
- Ежедневно проверяем появление конкурента; при появлении ставим флаг `lost_exclusive`.

### 2.4. Новинки
- Повышенная маржа, всегда ручное утверждение.
- Формула: `recommended = floor * (1 + new_item_markup)`; режим `manual_review = true`.

### 2.5. Дорогие товары
- Порог `expensive_threshold` (TBD). Всегда ручное утверждение, независимо от стратегии.
- Формула: используем выбранную стратегию (например, 2.2), затем флаг `manual_review = true`.

### 2.6. Дефицитные позиции
- Не опускаем цену ниже рынка; допускаем небольшую надбавку.
- Формула: `recommended = max(reference, floor) * (1 + deficit_markup)` (обычно ≥ 0).

### 2.7. Сверхнорматив/неликвид
- Ступенчатое снижение в зависимости от объёма остатков.
- Пример (подлежит уточнению):  
  - остаток ≥ 3: `discount_step1`  
  - остаток ≥ 5: `discount_step2`  
  - остаток ≥ 10: `discount_step3`  
- Режим по умолчанию — автоматический, если маржа остаётся ≥ минимальной.

### 2.8. Хвостовые и сомнительные матчи
- Если матч сомнительный → не применять автоматом, отправлять в ручной список.
- `manual_review = true`, рекомендация остаётся в истории с причиной `uncertain_match`.

### 2.9. Коррекция по валюте
- Если курс вырос/упал > `fx_threshold` → пересчитываем выбранные группы.
- Формула: `recommended = prior_price * (1 + fx_delta + logistics_fee)` (коэффициенты уточняются).
- Формируем отдельный отчёт/уведомление.

## 3. Приоритеты применения
1. Сомнительный матч → ручной режим (2.8).
2. Новинки → 2.4.
3. Эксклюзивы → 2.3.
4. Дорогие товары → 2.5.
5. Дефицит → 2.6.
6. Сверхнорматив/неликвид → 2.7.
7. Группа/брендовые правила → 2.2.
8. Общая базовая стратегия → 2.1.

Конкретный порядок может быть параметризован, но должен быть детерминирован и логироваться.

## 4. Требования к реализации и логированию
- Все расчёты должны возвращать:
  - применённую стратегию и параметры;
  - входные данные (закупка, цены конкурентов, статусы);
  - причины срабатывания ограничений/надбавок;
  - флаги `manual_review`, `uncertain_match`, `lost_exclusive`, `fx_adjustment`.
- История расчётов хранится согласно политике хранения (уточняется в архитектуре).
- Юнит-тесты: минимум happy-path, отсутствие данных конкурентов, эксклюзив, новинка, дефицит, неликвид, сомнительный матч.

## 5. Открытые вопросы и задачи
- Утвердить численные параметры: `min_margin`, `exclusive_markup`, `new_item_markup`, `deficit_markup`, `discount_steps`, `expensive_threshold`, `fx_threshold`.
- Уточнить список эталонных конкурентов по группам.
- Решить формат выходного файла для 1С (CSV/Excel/DBF) и тип цены.
- Задачи заносятся в `docs/plan.md` и детализируются в `tasks/`.
